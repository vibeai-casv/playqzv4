import{j as e,f as $}from"./index-DzWk5v5x.js";import{r as d}from"./vendor-D8AvkUoV.js";import{R,an as T,o as x,ao as q,p as U,T as I,i as n}from"./ui-CEq2p6SN.js";const P=async c=>(c("Seeder is currently disabled during migration to MySQL."),{successCount:0,failCount:0,skippedCount:0});function Q(){const[c,b]=d.useState(!1),[f,w]=d.useState([]),[y,N]=d.useState(!1),[j,a]=d.useState([]),[S,v]=d.useState(null),[m,E]=d.useState(!1),[C,u]=d.useState([]),h=o=>{w(i=>[...i,`[${new Date().toLocaleTimeString()}] ${o}`])},A=async()=>{if(confirm("This will insert questions from the local JSON files into the database. Continue?")){b(!0),w([]),h("Starting seed process...");try{const o=await P(i=>h(i));h(`Completed! Success: ${o.successCount}, Skipped: ${o.skippedCount}, Failed: ${o.failCount}`),n.success(`Seeding complete! Added ${o.successCount} questions.`)}catch(o){h(`Error: ${o.message}`),n.error("Seeding failed")}finally{b(!1)}}},L=async()=>{if(!confirm("This will update the database schema with any missing fields. This is safe to run multiple times. Continue?"))return;N(!0),a([]),v(null),a(t=>[...t,"ðŸ” Debug Information:"]),a(t=>[...t,`  window.location.pathname = "${window.location.pathname}"`]),a(t=>[...t,`  window.location.hostname = "${window.location.hostname}"`]);const o=window.location.pathname;a(t=>[...t,`  currentPath = "${o}"`]),a(t=>[...t,`  currentPath.startsWith('/aiq3/') = ${o.startsWith("/aiq3/")}`]);let i,r="";if(o.startsWith("/aiq3/"))i="/aiq3/api",r="Detected /aiq3/ in path";else if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")i="http://localhost:8000/api",r="Localhost detected";else{const t=window.location.pathname.split("/").slice(0,2).join("/");i=t?`${t}/api`:"/api",r=`Fallback: base="${t}"`}const l=`${i}/admin/update-schema.php`;a(t=>[...t,`  Detection Method: ${r}`]),a(t=>[...t,`  Detected API URL: ${i}`]),a(t=>[...t,`  Full Endpoint: ${l}`]),a(t=>[...t,`  Current Location: ${window.location.href}`]),a(t=>[...t,""]),a(t=>[...t,"Starting database schema update..."]);try{const t=await $("/admin/update-schema.php",{method:"POST"});v(t),t.success?(a(s=>[...s,"âœ… Schema update completed successfully"]),t.changes&&t.changes.length>0?(t.changes.forEach(s=>{a(p=>[...p,`  â€¢ ${s}`])}),n.success(`Schema updated! ${t.changes.length} change(s) applied.`)):(a(s=>[...s,"â„¹ï¸ No changes needed - schema is up to date"]),n.info("Schema is already up to date")),t.stats&&(a(s=>[...s,"","Database Statistics:"]),a(s=>[...s,`  - Tables Checked: ${t.stats.tablesChecked}`]),a(s=>[...s,`  - Fields Validated: ${t.stats.fieldsChecked}`]),a(s=>[...s,`  - Fields Added: ${t.stats.fieldsAdded}`]),a(s=>[...s,`  - Indexes Created: ${t.stats.indexesAdded}`]))):(a(s=>[...s,`âŒ Error: ${t.error||"Unknown error"}`]),n.error("Schema update failed"))}catch(t){a(s=>[...s,""]),a(s=>[...s,"âŒ Request Failed:"]),a(s=>[...s,`  Error: ${t.message}`]),a(s=>[...s,`  Type: ${t.constructor.name}`]),t.message.includes("404")&&(a(s=>[...s,""]),a(s=>[...s,"ðŸ’¡ Troubleshooting 404:"]),a(s=>[...s,"  1. Verify file exists on server"]),a(s=>[...s,`  2. Check: ${window.location.origin}/aiq2/api/admin/update-schema.php`]),a(s=>[...s,"  3. Ensure .htaccess is not blocking the file"]),a(s=>[...s,"  4. Check file permissions (should be 644)"])),console.error("Schema update error:",t),console.error("Full URL attempted:",l),n.error("Failed to update schema - check console for details")}finally{N(!1)}},_=async()=>{a([]),a(r=>[...r,"ðŸ” Testing API Connection..."]);const o=window.location.pathname;let i;if(o.startsWith("/aiq3/"))i="/aiq3/api";else if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")i="http://localhost:8000/api";else{const r=window.location.pathname.split("/").slice(0,2).join("/");i=r?`${r}/api`:"/api"}a(r=>[...r,`Current Path: ${window.location.pathname}`]),a(r=>[...r,`Detected API URL: ${i}`]);try{const r=`${i}/admin/test.php`;a(s=>[...s,`Testing: ${r}`]);const t=await(await fetch(r)).json();a(s=>[...s,"âœ… Connection successful!"]),a(s=>[...s,`Server Time: ${t.timestamp}`]),a(s=>[...s,`PHP Version: ${t.php_version}`]),a(s=>[...s,""]),a(s=>[...s,"Files in admin directory:"]),t.files_in_directory?.forEach(s=>{s!=="."&&s!==".."&&a(p=>[...p,`  - ${s}`])}),n.success("API connection test successful")}catch(r){a(l=>[...l,`âŒ Connection failed: ${r.message}`]),n.error("API connection test failed")}},g=async o=>{if(confirm(`This will activate all inactive questions of type "${o}". Continue?`)){E(!0),u([]);try{const i=await $("/admin/bulk-activate_types.php",{method:"POST",body:JSON.stringify({type:o})});i.success?(u(r=>[...r,`âœ… ${i.message}`]),n.success(i.message)):(u(r=>[...r,`âŒ Error: ${i.error}`]),n.error("Activation failed"))}catch(i){u(r=>[...r,`âŒ Request Failed: ${i.message}`]),n.error("Failed to communicate with API")}finally{E(!1)}}},k=`
-- 1. Create generate_quiz RPC
CREATE OR REPLACE FUNCTION public.generate_quiz(
    p_num_questions INTEGER,
    p_difficulty TEXT,
    p_categories TEXT[],
    p_time_limit INTEGER
)
RETURNS TABLE(question_ids UUID[]) AS $$
DECLARE
    v_question_ids UUID[];
BEGIN
    SELECT ARRAY_AGG(id)
    INTO v_question_ids
    FROM (
        SELECT id
        FROM public.questions
        WHERE 
            is_active = true AND
            (p_difficulty = 'Mixed' OR difficulty::TEXT = LOWER(p_difficulty)) AND
            (array_length(p_categories, 1) IS NULL OR category = ANY(p_categories))
        ORDER BY random()
        LIMIT p_num_questions
    ) sub;

    RETURN QUERY SELECT v_question_ids;
END;
$$ LANGUAGE plpgsql;

-- 2. Fix Permissions (Recursion)
CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1
    FROM public.profiles
    WHERE id = auth.uid() AND role = 'admin'
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Apply policies...
-- (See full migration file for policies)
`;return e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-gray-100 mb-8",children:"System Tools"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"bg-card rounded-xl shadow-sm border border-border p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"p-2 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg",children:e.jsx(R,{className:"w-6 h-6 text-indigo-600 dark:text-indigo-400"})}),e.jsx("h2",{className:"text-xl font-semibold text-foreground",children:"Database Schema Update"})]}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Update the database schema with any missing fields or indexes. This is safe to run multiple times and will only add what's missing."}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("button",{onClick:_,className:"w-full flex items-center justify-center px-4 py-2 border border-border rounded-md shadow-sm text-sm font-medium text-foreground bg-muted hover:bg-muted/80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",children:[e.jsx(T,{className:"w-4 h-4 mr-2"}),"Test API Connection"]}),e.jsx("button",{onClick:L,disabled:y,className:"w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed",children:y?e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"w-4 h-4 mr-2 animate-spin"}),"Updating Schema..."]}):e.jsxs(e.Fragment,{children:[e.jsx(x,{className:"w-4 h-4 mr-2"}),"Run Schema Update"]})})]}),j.length>0&&e.jsx("div",{className:"mt-6 bg-gray-900 dark:bg-gray-950 rounded-lg p-4 font-mono text-xs text-green-400 h-48 overflow-y-auto",children:j.map((o,i)=>e.jsx("div",{children:o},i))}),S&&S.success&&e.jsx("div",{className:"mt-4 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(x,{className:"w-5 h-5 text-green-600 dark:text-green-400 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-green-800 dark:text-green-200",children:[e.jsx("strong",{children:"Success!"})," Database schema has been updated successfully."]})]})})]}),e.jsxs("div",{className:"bg-card rounded-xl shadow-sm border border-border p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg",children:e.jsx(q,{className:"w-6 h-6 text-blue-600 dark:text-blue-400"})}),e.jsx("h2",{className:"text-xl font-semibold text-foreground",children:"Seed Question Bank"})]}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Import questions from the local JSON files (`qbank/`) into the Supabase database. Duplicates will be skipped automatically."}),e.jsx("button",{onClick:A,disabled:c,className:"w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:c?e.jsx(e.Fragment,{children:"Processing..."}):e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"w-4 h-4 mr-2"}),"Start Seeding"]})}),f.length>0&&e.jsx("div",{className:"mt-6 bg-gray-900 dark:bg-gray-950 rounded-lg p-4 font-mono text-xs text-green-400 h-48 overflow-y-auto",children:f.map((o,i)=>e.jsx("div",{children:o},i))})]}),e.jsxs("div",{className:"bg-card rounded-xl shadow-sm border border-border p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"p-2 bg-green-100 dark:bg-green-900/30 rounded-lg",children:e.jsx(x,{className:"w-6 h-6 text-green-600 dark:text-green-400"})}),e.jsx("h2",{className:"text-xl font-semibold text-foreground",children:"Bulk Activate Questions"})]}),e.jsx("p",{className:"text-muted-foreground mb-6",children:'Activate questions that are currently in "Draft" or "Inactive" status.'}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx("button",{onClick:()=>g("image_identify_person"),disabled:m,className:"flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-xs font-medium text-white bg-green-600 hover:bg-green-700 disabled:opacity-50",children:"Activate Person Questions"}),e.jsx("button",{onClick:()=>g("image_identify_logo"),disabled:m,className:"flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50",children:"Activate Logo Questions"}),e.jsx("button",{onClick:()=>g("text_mcq"),disabled:m,className:"flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-xs font-medium text-white bg-purple-600 hover:bg-purple-700 disabled:opacity-50",children:"Activate MCQ Questions"}),e.jsx("button",{onClick:()=>g("all"),disabled:m,className:"flex items-center justify-center px-4 py-2 border border-border rounded-md shadow-sm text-xs font-medium text-foreground bg-muted hover:bg-muted/80 disabled:opacity-50",children:"Activate ALL Questions"})]}),C.length>0&&e.jsx("div",{className:"mt-6 bg-gray-900 dark:bg-gray-950 rounded-lg p-4 font-mono text-xs text-green-400 h-24 overflow-y-auto",children:C.map((o,i)=>e.jsx("div",{children:o},i))})]})]}),e.jsxs("div",{className:"mt-8 bg-card rounded-xl shadow-sm border border-border p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"p-2 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg",children:e.jsx(I,{className:"w-6 h-6 text-yellow-600 dark:text-yellow-400"})}),e.jsx("h2",{className:"text-xl font-semibold text-foreground",children:"Database Setup Required"})]}),e.jsx("p",{className:"text-muted-foreground mb-4",children:'Some database functions (RPCs) cannot be created from this dashboard. If "Start Quiz" is failing, please run the following SQL in your Supabase SQL Editor:'}),e.jsxs("div",{className:"relative",children:[e.jsx("pre",{className:"bg-gray-50 dark:bg-gray-900 rounded-lg p-4 text-xs text-gray-700 dark:text-gray-300 overflow-x-auto h-64 border border-border",children:k}),e.jsx("button",{onClick:()=>{navigator.clipboard.writeText(k),n.success("SQL copied to clipboard")},className:"absolute top-2 right-2 p-2 bg-white dark:bg-gray-800 rounded shadow hover:bg-gray-50 dark:hover:bg-gray-700 text-xs font-medium text-gray-600 dark:text-gray-300 border border-border",children:"Copy SQL"})]}),e.jsxs("div",{className:"mt-4 flex items-start gap-2 text-sm text-muted-foreground",children:[e.jsx(T,{className:"w-4 h-4 mt-0.5 flex-shrink-0"}),e.jsx("p",{children:"Go to Supabase Dashboard â†’ SQL Editor â†’ New Query â†’ Paste & Run."})]})]})]})}export{Q as SystemTools};
