import{j as e,b as _,f as w}from"./index-DROaUFFW.js";import{r as d}from"./vendor-D8AvkUoV.js";import{R as E,an as C,o as u,ao as $,p as L,T as I,i}from"./ui-BHrEg2Uj.js";const q=async n=>(n("Seeder is currently disabled during migration to MySQL."),{successCount:0,failCount:0,skippedCount:0});function F(){const[n,g]=d.useState(!1),[h,x]=d.useState([]),[p,b]=d.useState(!1),[f,a]=d.useState([]),[y,N]=d.useState(null),[o,j]=d.useState(!1),[S,l]=d.useState([]),c=t=>{x(s=>[...s,`[${new Date().toLocaleTimeString()}] ${t}`])},k=async()=>{if(confirm("This will insert questions from the local JSON files into the database. Continue?")){g(!0),x([]),c("Starting seed process...");try{const t=await q(s=>c(s));c(`Completed! Success: ${t.successCount}, Skipped: ${t.skippedCount}, Failed: ${t.failCount}`),i.success(`Seeding complete! Added ${t.successCount} questions.`)}catch(t){c(`Error: ${t.message}`),i.error("Seeding failed")}finally{g(!1)}}},T=async()=>{if(confirm("This will update the database schema with any missing fields. This is safe to run multiple times. Continue?")){b(!0),a([]),N(null),a(t=>[...t,"Starting database schema update..."]),a(t=>[...t,"Starting database schema update..."]);try{const t=await w("/admin/update-schema.php",{method:"POST"});N(t),t.success?(a(s=>[...s,"âœ… Schema update completed successfully"]),t.changes&&t.changes.length>0?(t.changes.forEach(s=>{a(r=>[...r,`  â€¢ ${s}`])}),i.success(`Schema updated! ${t.changes.length} change(s) applied.`)):(a(s=>[...s,"â„¹ï¸ No changes needed - schema is up to date"]),i.info("Schema is already up to date")),t.stats&&(a(s=>[...s,"","Database Statistics:"]),a(s=>[...s,`  - Tables Checked: ${t.stats.tablesChecked}`]),a(s=>[...s,`  - Fields Validated: ${t.stats.fieldsChecked}`]),a(s=>[...s,`  - Fields Added: ${t.stats.fieldsAdded}`]),a(s=>[...s,`  - Indexes Created: ${t.stats.indexesAdded}`]))):(a(s=>[...s,`âŒ Error: ${t.error||"Unknown error"}`]),i.error("Schema update failed"))}catch(t){a(s=>[...s,""]),a(s=>[...s,"âŒ Request Failed:"]),a(s=>[...s,`  Error: ${t.message}`]),a(s=>[...s,`  Type: ${t.constructor.name}`]),t.message.includes("404")&&(a(s=>[...s,""]),a(s=>[...s,"ðŸ’¡ Troubleshooting 404:"]),a(s=>[...s,"  1. Verify file exists on server"]),a(s=>[...s,`  2. Check: ${window.location.origin}/aiq2/api/admin/update-schema.php`]),a(s=>[...s,"  3. Ensure .htaccess is not blocking the file"]),a(s=>[...s,"  4. Check file permissions (should be 644)"])),console.error("Schema update error:",t),i.error("Failed to update schema - check console for details")}finally{b(!1)}}},R=async()=>{a([]),a(t=>[...t,"ðŸ” Testing API Connection..."]),a(t=>[...t,`Current Path: ${window.location.pathname}`]);try{a(r=>[...r,"Testing endpoint: /admin/test.php"]);const s=(await _.get("/admin/test.php")).data;a(r=>[...r,"âœ… Connection successful!"]),a(r=>[...r,`Server Time: ${s.timestamp}`]),a(r=>[...r,`PHP Version: ${s.php_version}`]),a(r=>[...r,""]),a(r=>[...r,"Files in admin directory:"]),s.files_in_directory?.forEach(r=>{r!=="."&&r!==".."&&a(A=>[...A,`  - ${r}`])}),i.success("API connection test successful")}catch(t){a(s=>[...s,`âŒ Connection failed: ${t.message}`]),i.error("API connection test failed")}},m=async t=>{if(confirm(`This will activate all inactive questions of type "${t}". Continue?`)){j(!0),l([]);try{const s=await w("/admin/bulk-activate_types.php",{method:"POST",body:JSON.stringify({type:t})});s.success?(l(r=>[...r,`âœ… ${s.message}`]),i.success(s.message)):(l(r=>[...r,`âŒ Error: ${s.error}`]),i.error("Activation failed"))}catch(s){l(r=>[...r,`âŒ Request Failed: ${s.message}`]),i.error("Failed to communicate with API")}finally{j(!1)}}},v=`
-- 1. Create generate_quiz RPC
CREATE OR REPLACE FUNCTION public.generate_quiz(
    p_num_questions INTEGER,
    p_difficulty TEXT,
    p_categories TEXT[],
    p_time_limit INTEGER
)
RETURNS TABLE(question_ids UUID[]) AS $$
DECLARE
    v_question_ids UUID[];
BEGIN
    SELECT ARRAY_AGG(id)
    INTO v_question_ids
    FROM (
        SELECT id
        FROM public.questions
        WHERE 
            is_active = true AND
            (p_difficulty = 'Mixed' OR difficulty::TEXT = LOWER(p_difficulty)) AND
            (array_length(p_categories, 1) IS NULL OR category = ANY(p_categories))
        ORDER BY random()
        LIMIT p_num_questions
    ) sub;

    RETURN QUERY SELECT v_question_ids;
END;
$$ LANGUAGE plpgsql;

-- 2. Fix Permissions (Recursion)
CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1
    FROM public.profiles
    WHERE id = auth.uid() AND role = 'admin'
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Apply policies...
-- (See full migration file for policies)
`;return e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-gray-100 mb-8",children:"System Tools"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"bg-card rounded-xl shadow-sm border border-border p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"p-2 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg",children:e.jsx(E,{className:"w-6 h-6 text-indigo-600 dark:text-indigo-400"})}),e.jsx("h2",{className:"text-xl font-semibold text-foreground",children:"Database Schema Update"})]}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Update the database schema with any missing fields or indexes. This is safe to run multiple times and will only add what's missing."}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("button",{onClick:R,className:"w-full flex items-center justify-center px-4 py-2 border border-border rounded-md shadow-sm text-sm font-medium text-foreground bg-muted hover:bg-muted/80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",children:[e.jsx(C,{className:"w-4 h-4 mr-2"}),"Test API Connection"]}),e.jsx("button",{onClick:T,disabled:p,className:"w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed",children:p?e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"w-4 h-4 mr-2 animate-spin"}),"Updating Schema..."]}):e.jsxs(e.Fragment,{children:[e.jsx(u,{className:"w-4 h-4 mr-2"}),"Run Schema Update"]})})]}),f.length>0&&e.jsx("div",{className:"mt-6 bg-gray-900 dark:bg-gray-950 rounded-lg p-4 font-mono text-xs text-green-400 h-48 overflow-y-auto",children:f.map((t,s)=>e.jsx("div",{children:t},s))}),y&&y.success&&e.jsx("div",{className:"mt-4 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(u,{className:"w-5 h-5 text-green-600 dark:text-green-400 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-green-800 dark:text-green-200",children:[e.jsx("strong",{children:"Success!"})," Database schema has been updated successfully."]})]})})]}),e.jsxs("div",{className:"bg-card rounded-xl shadow-sm border border-border p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg",children:e.jsx($,{className:"w-6 h-6 text-blue-600 dark:text-blue-400"})}),e.jsx("h2",{className:"text-xl font-semibold text-foreground",children:"Seed Question Bank"})]}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Import questions from the local JSON files (`qbank/`) into the Supabase database. Duplicates will be skipped automatically."}),e.jsx("button",{onClick:k,disabled:n,className:"w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:n?e.jsx(e.Fragment,{children:"Processing..."}):e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"w-4 h-4 mr-2"}),"Start Seeding"]})}),h.length>0&&e.jsx("div",{className:"mt-6 bg-gray-900 dark:bg-gray-950 rounded-lg p-4 font-mono text-xs text-green-400 h-48 overflow-y-auto",children:h.map((t,s)=>e.jsx("div",{children:t},s))})]}),e.jsxs("div",{className:"bg-card rounded-xl shadow-sm border border-border p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"p-2 bg-green-100 dark:bg-green-900/30 rounded-lg",children:e.jsx(u,{className:"w-6 h-6 text-green-600 dark:text-green-400"})}),e.jsx("h2",{className:"text-xl font-semibold text-foreground",children:"Bulk Activate Questions"})]}),e.jsx("p",{className:"text-muted-foreground mb-6",children:'Activate questions that are currently in "Draft" or "Inactive" status.'}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx("button",{onClick:()=>m("image_identify_person"),disabled:o,className:"flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-xs font-medium text-white bg-green-600 hover:bg-green-700 disabled:opacity-50",children:"Activate Person Questions"}),e.jsx("button",{onClick:()=>m("image_identify_logo"),disabled:o,className:"flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50",children:"Activate Logo Questions"}),e.jsx("button",{onClick:()=>m("text_mcq"),disabled:o,className:"flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-xs font-medium text-white bg-purple-600 hover:bg-purple-700 disabled:opacity-50",children:"Activate MCQ Questions"}),e.jsx("button",{onClick:()=>m("all"),disabled:o,className:"flex items-center justify-center px-4 py-2 border border-border rounded-md shadow-sm text-xs font-medium text-foreground bg-muted hover:bg-muted/80 disabled:opacity-50",children:"Activate ALL Questions"})]}),S.length>0&&e.jsx("div",{className:"mt-6 bg-gray-900 dark:bg-gray-950 rounded-lg p-4 font-mono text-xs text-green-400 h-24 overflow-y-auto",children:S.map((t,s)=>e.jsx("div",{children:t},s))})]})]}),e.jsxs("div",{className:"mt-8 bg-card rounded-xl shadow-sm border border-border p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"p-2 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg",children:e.jsx(I,{className:"w-6 h-6 text-yellow-600 dark:text-yellow-400"})}),e.jsx("h2",{className:"text-xl font-semibold text-foreground",children:"Database Setup Required"})]}),e.jsx("p",{className:"text-muted-foreground mb-4",children:'Some database functions (RPCs) cannot be created from this dashboard. If "Start Quiz" is failing, please run the following SQL in your Supabase SQL Editor:'}),e.jsxs("div",{className:"relative",children:[e.jsx("pre",{className:"bg-gray-50 dark:bg-gray-900 rounded-lg p-4 text-xs text-gray-700 dark:text-gray-300 overflow-x-auto h-64 border border-border",children:v}),e.jsx("button",{onClick:()=>{navigator.clipboard.writeText(v),i.success("SQL copied to clipboard")},className:"absolute top-2 right-2 p-2 bg-white dark:bg-gray-800 rounded shadow hover:bg-gray-50 dark:hover:bg-gray-700 text-xs font-medium text-gray-600 dark:text-gray-300 border border-border",children:"Copy SQL"})]}),e.jsxs("div",{className:"mt-4 flex items-start gap-2 text-sm text-muted-foreground",children:[e.jsx(C,{className:"w-4 h-4 mt-0.5 flex-shrink-0"}),e.jsx("p",{children:"Go to Supabase Dashboard â†’ SQL Editor â†’ New Query â†’ Paste & Run."})]})]})]})}export{F as SystemTools};
