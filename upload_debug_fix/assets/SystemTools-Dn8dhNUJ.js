import{j as e,f as T}from"./index-Dylif5oX.js";import{r as d}from"./vendor-D8AvkUoV.js";import{R as y,ai as S,n as E,aj as v,o as k,T as $,h as n}from"./ui-BDjwW725.js";const A=async l=>(l("Seeder is currently disabled during migration to MySQL."),{successCount:0,failCount:0,skippedCount:0});function I(){const[l,u]=d.useState(!1),[m,h]=d.useState([]),[g,p]=d.useState(!1),[x,t]=d.useState([]),[f,b]=d.useState(null),c=i=>{h(r=>[...r,`[${new Date().toLocaleTimeString()}] ${i}`])},j=async()=>{if(confirm("This will insert questions from the local JSON files into the database. Continue?")){u(!0),h([]),c("Starting seed process...");try{const i=await A(r=>c(r));c(`Completed! Success: ${i.successCount}, Skipped: ${i.skippedCount}, Failed: ${i.failCount}`),n.success(`Seeding complete! Added ${i.successCount} questions.`)}catch(i){c(`Error: ${i.message}`),n.error("Seeding failed")}finally{u(!1)}}},w=async()=>{if(!confirm("This will update the database schema with any missing fields. This is safe to run multiple times. Continue?"))return;p(!0),t([]),b(null);const i="https://aiquiz.vibeai.cv/api",r=`${i}/admin/update-schema.php`;t(a=>[...a,"ðŸ” Debug Information:"]),t(a=>[...a,"  Environment: PRODUCTION"]),t(a=>[...a,`  API Base URL: ${i}`]),t(a=>[...a,`  Full Endpoint: ${r}`]),t(a=>[...a,`  Current Location: ${window.location.href}`]),t(a=>[...a,""]),t(a=>[...a,"Starting database schema update..."]);try{const a=await T("/admin/update-schema.php",{method:"POST"});b(a),a.success?(t(s=>[...s,"âœ… Schema update completed successfully"]),a.changes&&a.changes.length>0?(a.changes.forEach(s=>{t(o=>[...o,`  â€¢ ${s}`])}),n.success(`Schema updated! ${a.changes.length} change(s) applied.`)):(t(s=>[...s,"â„¹ï¸ No changes needed - schema is up to date"]),n.info("Schema is already up to date")),a.stats&&(t(s=>[...s,"","Database Statistics:"]),t(s=>[...s,`  - Tables Checked: ${a.stats.tablesChecked}`]),t(s=>[...s,`  - Fields Validated: ${a.stats.fieldsChecked}`]),t(s=>[...s,`  - Fields Added: ${a.stats.fieldsAdded}`]),t(s=>[...s,`  - Indexes Created: ${a.stats.indexesAdded}`]))):(t(s=>[...s,`âŒ Error: ${a.error||"Unknown error"}`]),n.error("Schema update failed"))}catch(a){t(s=>[...s,""]),t(s=>[...s,"âŒ Request Failed:"]),t(s=>[...s,`  Error: ${a.message}`]),t(s=>[...s,`  Type: ${a.constructor.name}`]),a.message.includes("404")&&(t(s=>[...s,""]),t(s=>[...s,"ðŸ’¡ Troubleshooting 404:"]),t(s=>[...s,"  1. Verify file exists on server"]),t(s=>[...s,`  2. Check: ${window.location.origin}/aiq2/api/admin/update-schema.php`]),t(s=>[...s,"  3. Ensure .htaccess is not blocking the file"]),t(s=>[...s,"  4. Check file permissions (should be 644)"])),console.error("Schema update error:",a),console.error("Full URL attempted:",r),n.error("Failed to update schema - check console for details")}finally{p(!1)}},R=async()=>{t([]),t(r=>[...r,"ðŸ” Testing API Connection..."]);const i="https://aiquiz.vibeai.cv/api";t(r=>[...r,`API URL: ${i}`]);try{const r=`${i}/admin/test.php`;t(o=>[...o,`Testing: ${r}`]);const s=await(await fetch(r)).json();t(o=>[...o,"âœ… Connection successful!"]),t(o=>[...o,`Server Time: ${s.timestamp}`]),t(o=>[...o,`PHP Version: ${s.php_version}`]),t(o=>[...o,""]),t(o=>[...o,"Files in admin directory:"]),s.files_in_directory?.forEach(o=>{o!=="."&&o!==".."&&t(C=>[...C,`  - ${o}`])}),n.success("API connection test successful")}catch(r){t(a=>[...a,`âŒ Connection failed: ${r.message}`]),n.error("API connection test failed")}},N=`
-- 1. Create generate_quiz RPC
CREATE OR REPLACE FUNCTION public.generate_quiz(
    p_num_questions INTEGER,
    p_difficulty TEXT,
    p_categories TEXT[],
    p_time_limit INTEGER
)
RETURNS TABLE(question_ids UUID[]) AS $$
DECLARE
    v_question_ids UUID[];
BEGIN
    SELECT ARRAY_AGG(id)
    INTO v_question_ids
    FROM (
        SELECT id
        FROM public.questions
        WHERE 
            is_active = true AND
            (p_difficulty = 'Mixed' OR difficulty::TEXT = LOWER(p_difficulty)) AND
            (array_length(p_categories, 1) IS NULL OR category = ANY(p_categories))
        ORDER BY random()
        LIMIT p_num_questions
    ) sub;

    RETURN QUERY SELECT v_question_ids;
END;
$$ LANGUAGE plpgsql;

-- 2. Fix Permissions (Recursion)
CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1
    FROM public.profiles
    WHERE id = auth.uid() AND role = 'admin'
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Apply policies...
-- (See full migration file for policies)
`;return e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-gray-100 mb-8",children:"System Tools"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"bg-card rounded-xl shadow-sm border border-border p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"p-2 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg",children:e.jsx(y,{className:"w-6 h-6 text-indigo-600 dark:text-indigo-400"})}),e.jsx("h2",{className:"text-xl font-semibold text-foreground",children:"Database Schema Update"})]}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Update the database schema with any missing fields or indexes. This is safe to run multiple times and will only add what's missing."}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("button",{onClick:R,className:"w-full flex items-center justify-center px-4 py-2 border border-border rounded-md shadow-sm text-sm font-medium text-foreground bg-muted hover:bg-muted/80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",children:[e.jsx(S,{className:"w-4 h-4 mr-2"}),"Test API Connection"]}),e.jsx("button",{onClick:w,disabled:g,className:"w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed",children:g?e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"w-4 h-4 mr-2 animate-spin"}),"Updating Schema..."]}):e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"w-4 h-4 mr-2"}),"Run Schema Update"]})})]}),x.length>0&&e.jsx("div",{className:"mt-6 bg-gray-900 dark:bg-gray-950 rounded-lg p-4 font-mono text-xs text-green-400 h-48 overflow-y-auto",children:x.map((i,r)=>e.jsx("div",{children:i},r))}),f&&f.success&&e.jsx("div",{className:"mt-4 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(E,{className:"w-5 h-5 text-green-600 dark:text-green-400 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-green-800 dark:text-green-200",children:[e.jsx("strong",{children:"Success!"})," Database schema has been updated successfully."]})]})})]}),e.jsxs("div",{className:"bg-card rounded-xl shadow-sm border border-border p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg",children:e.jsx(v,{className:"w-6 h-6 text-blue-600 dark:text-blue-400"})}),e.jsx("h2",{className:"text-xl font-semibold text-foreground",children:"Seed Question Bank"})]}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Import questions from the local JSON files (`qbank/`) into the Supabase database. Duplicates will be skipped automatically."}),e.jsx("button",{onClick:j,disabled:l,className:"w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:l?e.jsx(e.Fragment,{children:"Processing..."}):e.jsxs(e.Fragment,{children:[e.jsx(k,{className:"w-4 h-4 mr-2"}),"Start Seeding"]})}),m.length>0&&e.jsx("div",{className:"mt-6 bg-gray-900 dark:bg-gray-950 rounded-lg p-4 font-mono text-xs text-green-400 h-48 overflow-y-auto",children:m.map((i,r)=>e.jsx("div",{children:i},r))})]})]}),e.jsxs("div",{className:"mt-8 bg-card rounded-xl shadow-sm border border-border p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"p-2 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg",children:e.jsx($,{className:"w-6 h-6 text-yellow-600 dark:text-yellow-400"})}),e.jsx("h2",{className:"text-xl font-semibold text-foreground",children:"Database Setup Required"})]}),e.jsx("p",{className:"text-muted-foreground mb-4",children:'Some database functions (RPCs) cannot be created from this dashboard. If "Start Quiz" is failing, please run the following SQL in your Supabase SQL Editor:'}),e.jsxs("div",{className:"relative",children:[e.jsx("pre",{className:"bg-gray-50 dark:bg-gray-900 rounded-lg p-4 text-xs text-gray-700 dark:text-gray-300 overflow-x-auto h-64 border border-border",children:N}),e.jsx("button",{onClick:()=>{navigator.clipboard.writeText(N),n.success("SQL copied to clipboard")},className:"absolute top-2 right-2 p-2 bg-white dark:bg-gray-800 rounded shadow hover:bg-gray-50 dark:hover:bg-gray-700 text-xs font-medium text-gray-600 dark:text-gray-300 border border-border",children:"Copy SQL"})]}),e.jsxs("div",{className:"mt-4 flex items-start gap-2 text-sm text-muted-foreground",children:[e.jsx(S,{className:"w-4 h-4 mt-0.5 flex-shrink-0"}),e.jsx("p",{children:"Go to Supabase Dashboard â†’ SQL Editor â†’ New Query â†’ Paste & Run."})]})]})]})}export{I as SystemTools};
