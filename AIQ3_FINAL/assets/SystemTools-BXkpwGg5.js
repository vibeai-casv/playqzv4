import{j as s,f as T}from"./index-fliBAwov.js";import{r as l}from"./vendor-D8AvkUoV.js";import{R as S,aj as E,o as j,ak as k,p as v,T as A,i as n}from"./ui-mytIhYa7.js";const L=async c=>(c("Seeder is currently disabled during migration to MySQL."),{successCount:0,failCount:0,skippedCount:0});function I(){const[c,h]=l.useState(!1),[p,g]=l.useState([]),[x,f]=l.useState(!1),[b,a]=l.useState([]),[w,N]=l.useState(null),m=o=>{g(i=>[...i,`[${new Date().toLocaleTimeString()}] ${o}`])},R=async()=>{if(confirm("This will insert questions from the local JSON files into the database. Continue?")){h(!0),g([]),m("Starting seed process...");try{const o=await L(i=>m(i));m(`Completed! Success: ${o.successCount}, Skipped: ${o.skippedCount}, Failed: ${o.failCount}`),n.success(`Seeding complete! Added ${o.successCount} questions.`)}catch(o){m(`Error: ${o.message}`),n.error("Seeding failed")}finally{h(!1)}}},C=async()=>{if(!confirm("This will update the database schema with any missing fields. This is safe to run multiple times. Continue?"))return;f(!0),a([]),N(null),a(t=>[...t,"ðŸ” Debug Information:"]),a(t=>[...t,`  window.location.pathname = "${window.location.pathname}"`]),a(t=>[...t,`  window.location.hostname = "${window.location.hostname}"`]);const o=window.location.pathname;a(t=>[...t,`  currentPath = "${o}"`]),a(t=>[...t,`  currentPath.startsWith('/aiq3/') = ${o.startsWith("/aiq3/")}`]);let i,r="";if(o.startsWith("/aiq3/"))i="/aiq3/api",r="Detected /aiq3/ in path";else if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")i="http://localhost:8000/api",r="Localhost detected";else{const t=window.location.pathname.split("/").slice(0,2).join("/");i=t?`${t}/api`:"/api",r=`Fallback: base="${t}"`}const d=`${i}/admin/update-schema.php`;a(t=>[...t,`  Detection Method: ${r}`]),a(t=>[...t,`  Detected API URL: ${i}`]),a(t=>[...t,`  Full Endpoint: ${d}`]),a(t=>[...t,`  Current Location: ${window.location.href}`]),a(t=>[...t,""]),a(t=>[...t,"Starting database schema update..."]);try{const t=await T("/admin/update-schema.php",{method:"POST"});N(t),t.success?(a(e=>[...e,"âœ… Schema update completed successfully"]),t.changes&&t.changes.length>0?(t.changes.forEach(e=>{a(u=>[...u,`  â€¢ ${e}`])}),n.success(`Schema updated! ${t.changes.length} change(s) applied.`)):(a(e=>[...e,"â„¹ï¸ No changes needed - schema is up to date"]),n.info("Schema is already up to date")),t.stats&&(a(e=>[...e,"","Database Statistics:"]),a(e=>[...e,`  - Tables Checked: ${t.stats.tablesChecked}`]),a(e=>[...e,`  - Fields Validated: ${t.stats.fieldsChecked}`]),a(e=>[...e,`  - Fields Added: ${t.stats.fieldsAdded}`]),a(e=>[...e,`  - Indexes Created: ${t.stats.indexesAdded}`]))):(a(e=>[...e,`âŒ Error: ${t.error||"Unknown error"}`]),n.error("Schema update failed"))}catch(t){a(e=>[...e,""]),a(e=>[...e,"âŒ Request Failed:"]),a(e=>[...e,`  Error: ${t.message}`]),a(e=>[...e,`  Type: ${t.constructor.name}`]),t.message.includes("404")&&(a(e=>[...e,""]),a(e=>[...e,"ðŸ’¡ Troubleshooting 404:"]),a(e=>[...e,"  1. Verify file exists on server"]),a(e=>[...e,`  2. Check: ${window.location.origin}/aiq2/api/admin/update-schema.php`]),a(e=>[...e,"  3. Ensure .htaccess is not blocking the file"]),a(e=>[...e,"  4. Check file permissions (should be 644)"])),console.error("Schema update error:",t),console.error("Full URL attempted:",d),n.error("Failed to update schema - check console for details")}finally{f(!1)}},$=async()=>{a([]),a(r=>[...r,"ðŸ” Testing API Connection..."]);const o=window.location.pathname;let i;if(o.startsWith("/aiq3/"))i="/aiq3/api";else if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")i="http://localhost:8000/api";else{const r=window.location.pathname.split("/").slice(0,2).join("/");i=r?`${r}/api`:"/api"}a(r=>[...r,`Current Path: ${window.location.pathname}`]),a(r=>[...r,`Detected API URL: ${i}`]);try{const r=`${i}/admin/test.php`;a(e=>[...e,`Testing: ${r}`]);const t=await(await fetch(r)).json();a(e=>[...e,"âœ… Connection successful!"]),a(e=>[...e,`Server Time: ${t.timestamp}`]),a(e=>[...e,`PHP Version: ${t.php_version}`]),a(e=>[...e,""]),a(e=>[...e,"Files in admin directory:"]),t.files_in_directory?.forEach(e=>{e!=="."&&e!==".."&&a(u=>[...u,`  - ${e}`])}),n.success("API connection test successful")}catch(r){a(d=>[...d,`âŒ Connection failed: ${r.message}`]),n.error("API connection test failed")}},y=`
-- 1. Create generate_quiz RPC
CREATE OR REPLACE FUNCTION public.generate_quiz(
    p_num_questions INTEGER,
    p_difficulty TEXT,
    p_categories TEXT[],
    p_time_limit INTEGER
)
RETURNS TABLE(question_ids UUID[]) AS $$
DECLARE
    v_question_ids UUID[];
BEGIN
    SELECT ARRAY_AGG(id)
    INTO v_question_ids
    FROM (
        SELECT id
        FROM public.questions
        WHERE 
            is_active = true AND
            (p_difficulty = 'Mixed' OR difficulty::TEXT = LOWER(p_difficulty)) AND
            (array_length(p_categories, 1) IS NULL OR category = ANY(p_categories))
        ORDER BY random()
        LIMIT p_num_questions
    ) sub;

    RETURN QUERY SELECT v_question_ids;
END;
$$ LANGUAGE plpgsql;

-- 2. Fix Permissions (Recursion)
CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1
    FROM public.profiles
    WHERE id = auth.uid() AND role = 'admin'
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Apply policies...
-- (See full migration file for policies)
`;return s.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[s.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-gray-100 mb-8",children:"System Tools"}),s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[s.jsxs("div",{className:"bg-card rounded-xl shadow-sm border border-border p-6",children:[s.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[s.jsx("div",{className:"p-2 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg",children:s.jsx(S,{className:"w-6 h-6 text-indigo-600 dark:text-indigo-400"})}),s.jsx("h2",{className:"text-xl font-semibold text-foreground",children:"Database Schema Update"})]}),s.jsx("p",{className:"text-muted-foreground mb-6",children:"Update the database schema with any missing fields or indexes. This is safe to run multiple times and will only add what's missing."}),s.jsxs("div",{className:"space-y-3",children:[s.jsxs("button",{onClick:$,className:"w-full flex items-center justify-center px-4 py-2 border border-border rounded-md shadow-sm text-sm font-medium text-foreground bg-muted hover:bg-muted/80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",children:[s.jsx(E,{className:"w-4 h-4 mr-2"}),"Test API Connection"]}),s.jsx("button",{onClick:C,disabled:x,className:"w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed",children:x?s.jsxs(s.Fragment,{children:[s.jsx(S,{className:"w-4 h-4 mr-2 animate-spin"}),"Updating Schema..."]}):s.jsxs(s.Fragment,{children:[s.jsx(j,{className:"w-4 h-4 mr-2"}),"Run Schema Update"]})})]}),b.length>0&&s.jsx("div",{className:"mt-6 bg-gray-900 dark:bg-gray-950 rounded-lg p-4 font-mono text-xs text-green-400 h-48 overflow-y-auto",children:b.map((o,i)=>s.jsx("div",{children:o},i))}),w&&w.success&&s.jsx("div",{className:"mt-4 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg",children:s.jsxs("div",{className:"flex items-start gap-2",children:[s.jsx(j,{className:"w-5 h-5 text-green-600 dark:text-green-400 mt-0.5 flex-shrink-0"}),s.jsxs("div",{className:"text-sm text-green-800 dark:text-green-200",children:[s.jsx("strong",{children:"Success!"})," Database schema has been updated successfully."]})]})})]}),s.jsxs("div",{className:"bg-card rounded-xl shadow-sm border border-border p-6",children:[s.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[s.jsx("div",{className:"p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg",children:s.jsx(k,{className:"w-6 h-6 text-blue-600 dark:text-blue-400"})}),s.jsx("h2",{className:"text-xl font-semibold text-foreground",children:"Seed Question Bank"})]}),s.jsx("p",{className:"text-muted-foreground mb-6",children:"Import questions from the local JSON files (`qbank/`) into the Supabase database. Duplicates will be skipped automatically."}),s.jsx("button",{onClick:R,disabled:c,className:"w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:c?s.jsx(s.Fragment,{children:"Processing..."}):s.jsxs(s.Fragment,{children:[s.jsx(v,{className:"w-4 h-4 mr-2"}),"Start Seeding"]})}),p.length>0&&s.jsx("div",{className:"mt-6 bg-gray-900 dark:bg-gray-950 rounded-lg p-4 font-mono text-xs text-green-400 h-48 overflow-y-auto",children:p.map((o,i)=>s.jsx("div",{children:o},i))})]})]}),s.jsxs("div",{className:"mt-8 bg-card rounded-xl shadow-sm border border-border p-6",children:[s.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[s.jsx("div",{className:"p-2 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg",children:s.jsx(A,{className:"w-6 h-6 text-yellow-600 dark:text-yellow-400"})}),s.jsx("h2",{className:"text-xl font-semibold text-foreground",children:"Database Setup Required"})]}),s.jsx("p",{className:"text-muted-foreground mb-4",children:'Some database functions (RPCs) cannot be created from this dashboard. If "Start Quiz" is failing, please run the following SQL in your Supabase SQL Editor:'}),s.jsxs("div",{className:"relative",children:[s.jsx("pre",{className:"bg-gray-50 dark:bg-gray-900 rounded-lg p-4 text-xs text-gray-700 dark:text-gray-300 overflow-x-auto h-64 border border-border",children:y}),s.jsx("button",{onClick:()=>{navigator.clipboard.writeText(y),n.success("SQL copied to clipboard")},className:"absolute top-2 right-2 p-2 bg-white dark:bg-gray-800 rounded shadow hover:bg-gray-50 dark:hover:bg-gray-700 text-xs font-medium text-gray-600 dark:text-gray-300 border border-border",children:"Copy SQL"})]}),s.jsxs("div",{className:"mt-4 flex items-start gap-2 text-sm text-muted-foreground",children:[s.jsx(E,{className:"w-4 h-4 mt-0.5 flex-shrink-0"}),s.jsx("p",{children:"Go to Supabase Dashboard â†’ SQL Editor â†’ New Query â†’ Paste & Run."})]})]})]})}export{I as SystemTools};
